<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Data Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: white;
            margin-bottom: 20px;
        }

        .btn-primary {
            background: #007bff;
        }

        .btn-edit {
            background: #ffc107;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-delete {
            background: #dc3545;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-save {
            background: #28a745;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-cancel {
            background: #6c757d;
            padding: 6px 12px;
            font-size: 12px;
        }

        .status {
            margin-left: 10px;
            padding: 5px 15px;
            border-radius: 4px;
            font-size: 13px;
        }

        .status.loading {
            background: #fff3cd;
            color: #856404;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #007bff;
            color: white;
            padding: 12px;
            text-align: left;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .actions {
            display: flex;
            gap: 5px;
        }

        input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CSV Data Viewer</h1>
        <button class="btn-primary" onclick="loadData()">Refresh</button>
        <span class="status" id="status"></span>
        <div id="tableContent"></div>
    </div>

    <script>
        let editingRow = null;
        let originalData = null;

        document.addEventListener('DOMContentLoaded', loadData);

        function showStatus(msg, type) {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.className = `status ${type}`;
            if (type !== 'loading') setTimeout(() => el.className = 'status', 3000);
        }

        async function loadData() {
            const content = document.getElementById('tableContent');
            showStatus('Loading...', 'loading');

            try {
                const res = await fetch('http://localhost:4000/api/csv');
                if (!res.ok) throw new Error('Failed to fetch');
                const data = await res.json();

                const cols = [...new Set(data.flatMap(row => Object.keys(row)))];
                let html = '<table><thead><tr>';
                cols.forEach(col => html += `<th>${col}</th>`);
                html += '<th>Actions</th></tr></thead><tbody>';

                data.forEach((row, i) => {
                    html += `<tr id="row-${i}">`;
                    cols.forEach(col => html += `<td data-column="${col}">${row[col] || '-'}</td>`);
                    html += `<td><div class="actions">
                        <button class="btn-edit" onclick='editRow(${i}, ${JSON.stringify(row)})'>Edit</button>
                        <button class="btn-delete" onclick='deleteRow(${JSON.stringify(row)})'>Delete</button>
                    </div></td></tr>`;
                });

                content.innerHTML = html + '</tbody></table>';
                showStatus(`Loaded ${data.length} rows`, 'success');
            } catch (error) {
                showStatus('Failed to load', 'error');
            }
        }

        function editRow(i, data) {
            if (editingRow !== null) return showStatus('Save current edit first', 'error');
            
            editingRow = i;
            originalData = data;
            const row = document.getElementById(`row-${i}`);
            
            row.querySelectorAll('td[data-column]').forEach(cell => {
                const col = cell.getAttribute('data-column');
                const val = cell.textContent === '-' ? '' : cell.textContent;
                cell.innerHTML = `<input type="text" value="${val}" data-column="${col}">`;
            });

            row.querySelector('.actions').innerHTML = `
                <button class="btn-save" onclick="saveRow(${i})">Save</button>
                <button class="btn-cancel" onclick="cancelEdit()">Cancel</button>
            `;
        }

        function cancelEdit() {
            editingRow = null;
            originalData = null;
            loadData();
        }

        async function saveRow(i) {
            const row = document.getElementById(`row-${i}`);
            const updates = {};
            
            row.querySelectorAll('input[data-column]').forEach(input => {
                updates[input.getAttribute('data-column')] = input.value;
            });

            showStatus('Updating...', 'loading');

            try {
                const params = new URLSearchParams(originalData);
                const res = await fetch(`http://localhost:4000/api/csv?${params}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });

                if (!res.ok) throw new Error('Update failed');
                showStatus('Updated', 'success');
                editingRow = null;
                originalData = null;
                setTimeout(loadData, 500);
            } catch (error) {
                showStatus('Update failed', 'error');
            }
        }

        async function deleteRow(data) {
            if (!confirm('Delete this row?')) return;
            showStatus('Deleting...', 'loading');

            try {
                const params = new URLSearchParams(data);
                const res = await fetch(`http://localhost:4000/api/csv?${params}`, {
                    method: 'DELETE'
                });

                if (!res.ok) throw new Error('Delete failed');
                showStatus('Deleted', 'success');
                setTimeout(loadData, 500);
            } catch (error) {
                showStatus('Delete failed', 'error');
            }
        }
    </script>
</body>
</html>
